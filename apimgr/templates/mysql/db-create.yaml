{{- if and (eq .Values.mysql.enabled true) (eq .Values.mysql.init true) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: db-create-mysql-apigw-{{ uuidv4 }}
  namespace: {{ .Values.namespace }}
  labels:  
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
spec:
 template:
  spec:
   containers:
    - name: dbcreate-mysql-analytics
      image: {{ .Values.mysql.imageName }}:{{ .Values.mysql.imageTag }}
      command: 
      - "sh" 
      - "-c" 
      args:
      - "SQL_COMMANDS=$(cat /tmp/mysql/analytics.sql); mysql -u{{ .Values.mysql.username }} -p${MYSQL_PASSWORD} {{ .Values.mysql.databaseName }} -h {{ .Values.mysql.hostname }} -e \"${SQL_COMMANDS} \""
      volumeMounts:
      - name: config-volume
        mountPath: /tmp/mysql
      env:
      - name: MYSQL_PASSWORD
      {{- if ne .Values.mysql.existingSecret "" }}
        valueFrom:
          secretKeyRef:
            key: mysql-password
            name: {{ .Values.mysql.existingSecret }}
      {{ else }}
        value: {{ .Values.mysql.password }}
      {{- end }}
   volumes:
    - name: config-volume
      configMap:
        # Provide the name of the ConfigMap containing the files you want
        # to add to the container
        name: analytics
   restartPolicy: Never
{{- end }}
